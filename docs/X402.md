# x402 Integration - CronosAI Ops

## Principio Central

> x402 no es un add-on. Es el MOTOR del producto.

Sin x402, CronosAI Ops no tiene modelo de negocio.
Cada capability tiene un precio. Cada precio se cobra via x402.

---

## Cómo Funciona x402

### El Protocolo

x402 revive el código HTTP 402 "Payment Required" para pagos programáticos:

```
1. Cliente hace request a recurso de pago
   POST /capability/contract-scan

2. Servidor responde 402 con instrucciones de pago
   HTTP 402 Payment Required
   {
     "price": "0.01",
     "token": "USDC",
     "network": "cronos",
     "recipient": "0x...",
     "facilitator": "https://x402-facilitator.cronos.org"
   }

3. Cliente paga via facilitator
   - Firma transacción
   - Facilitator procesa
   - Recibe proof de pago

4. Cliente re-envía request con proof
   POST /capability/contract-scan
   Headers: { "X-Payment": "<proof>" }

5. Servidor verifica y responde
   HTTP 200 OK
   { resultado }
```

### Latencia Típica

| Paso | Tiempo |
|------|--------|
| Request inicial | ~50ms |
| Respuesta 402 | ~10ms |
| Usuario firma | Variable (user action) |
| Verificación facilitator | ~200ms |
| Ejecución capability | ~1-3s |
| **Total (sin user action)** | **~1.5-3.5s** |

---

## Implementación

### Setup del Middleware

```typescript
// src/api/middleware/x402.ts

import { paymentMiddleware, PaymentConfig } from '@x402/express';

// Precios por capability
const PRICES: Record<string, PaymentConfig> = {
  'POST /capability/contract-scan': {
    price: '$0.01',
    network: 'cronos',
    token: 'USDC',
    recipient: process.env.RECIPIENT_ADDRESS!,
    description: 'Contract security scan',
  },
  'POST /capability/wallet-approvals': {
    price: '$0.02',
    network: 'cronos',
    token: 'USDC',
    recipient: process.env.RECIPIENT_ADDRESS!,
    description: 'Wallet approvals check',
  },
  'POST /capability/tx-simulate': {
    price: '$0.03',
    network: 'cronos',
    token: 'USDC',
    recipient: process.env.RECIPIENT_ADDRESS!,
    description: 'Transaction simulation',
  },
};

// Crear middleware
export const x402 = paymentMiddleware(PRICES, {
  facilitatorUrl: process.env.X402_FACILITATOR_URL,
});
```

### Aplicar en Express

```typescript
// src/api/index.ts

import express from 'express';
import { x402 } from './middleware/x402';
import { capabilitiesRouter } from './routes/capabilities';

const app = express();

// Middleware global
app.use(express.json());
app.use(cors());
app.use(helmet());

// x402 solo en rutas de capabilities
app.use('/capability', x402);

// Rutas
app.use('/capability', capabilitiesRouter);
app.use('/health', healthRouter);

// Error handler
app.use(errorHandler);
```

### Route de Capability

```typescript
// src/api/routes/capabilities.ts

import { Router } from 'express';
import { executeCapability } from '../../core/orchestrator';

const router = Router();

// POST /capability/:name
router.post('/:name', async (req, res, next) => {
  try {
    const { name } = req.params;
    const input = req.body;
    
    // Si llegamos aquí, x402 ya verificó el pago
    const result = await executeCapability(name, input);
    
    res.json({
      success: true,
      capability: name,
      cost: getCapabilityPrice(name),
      result,
    });
  } catch (error) {
    next(error);
  }
});

export { router as capabilitiesRouter };
```

---

## Wallet de Recepción

### Configuración Recomendada

```
1. Crear wallet NUEVA solo para el proyecto
   - No usar wallet personal
   - No usar wallet con otros fondos

2. Guardar private key de forma segura
   - Solo en .env (no commitear)
   - En producción: usar secrets manager

3. Esta wallet RECIBE los pagos
   - Verificar balance regularmente
   - Mover fondos si acumulan
```

### Ejemplo .env

```env
# Wallet que RECIBE pagos x402
RECIPIENT_ADDRESS=0x1234567890abcdef...

# Private key (solo si necesitás hacer queries)
# NO es necesario para recibir pagos
PRIVATE_KEY=0xabcdef...
```

---

## Manejo de Errores x402

### Errores Comunes

```typescript
// src/api/middleware/error.ts

export function errorHandler(err: any, req: Request, res: Response, next: NextFunction) {
  // Error de pago x402
  if (err.code === 'PAYMENT_REQUIRED') {
    // Ya manejado por middleware x402
    return;
  }
  
  if (err.code === 'PAYMENT_INVALID') {
    return res.status(402).json({
      error: 'PAYMENT_INVALID',
      message: 'El pago no pudo ser verificado. Intentá de nuevo.',
    });
  }
  
  if (err.code === 'PAYMENT_EXPIRED') {
    return res.status(402).json({
      error: 'PAYMENT_EXPIRED',
      message: 'El pago expiró. Por favor realizá un nuevo pago.',
    });
  }
  
  // Otros errores
  console.error('Unhandled error:', err);
  res.status(500).json({
    error: 'INTERNAL_ERROR',
    message: 'Ocurrió un error. Intentá de nuevo.',
  });
}
```

### Retry Logic en Frontend

```typescript
// web/src/hooks/useCapability.ts

async function executeWithPayment(capability: string, input: any) {
  // Primer intento - obtendrá 402
  const response = await fetch(`/capability/${capability}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(input),
  });
  
  if (response.status === 402) {
    // Obtener instrucciones de pago
    const paymentInfo = await response.json();
    
    // Ejecutar pago via x402
    const paymentProof = await executeX402Payment(paymentInfo);
    
    // Re-intentar con proof
    const retryResponse = await fetch(`/capability/${capability}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Payment': paymentProof,
      },
      body: JSON.stringify(input),
    });
    
    if (!retryResponse.ok) {
      throw new Error('Payment verification failed');
    }
    
    return retryResponse.json();
  }
  
  return response.json();
}
```

---

## Testing x402

### Test en Desarrollo (Sin Pagos Reales)

```typescript
// Para desarrollo, podemos mockear x402

// src/api/middleware/x402-mock.ts
export function x402Mock(req: Request, res: Response, next: NextFunction) {
  if (process.env.NODE_ENV === 'development' && process.env.SKIP_X402 === 'true') {
    // Skip payment verification en desarrollo
    console.log(`[x402 MOCK] Skipping payment for ${req.path}`);
    return next();
  }
  
  // En producción, usar middleware real
  return x402(req, res, next);
}
```

### Test con Testnet

```env
# Para testing real con testnet
X402_FACILITATOR_URL=https://x402-facilitator-testnet.cronos.org
CHAIN_ID=338
CRONOS_RPC_URL=https://evm-t3.cronos.org
```

---

## Consideraciones de Seguridad

### DO's ✅

- Verificar SIEMPRE el pago antes de ejecutar
- Usar HTTPS en producción
- Validar inputs después del pago
- Loggear todas las transacciones
- Manejar errores gracefully

### DON'Ts ❌

- NUNCA ejecutar sin verificar pago
- NO confiar en headers del cliente
- NO exponer private keys
- NO hardcodear precios (usar config)

---

## Monitoreo

### Logs Recomendados

```typescript
// Loggear cada transacción
logger.info('x402_payment', {
  capability: name,
  price: getCapabilityPrice(name),
  payment_id: paymentProof.id,
  timestamp: new Date().toISOString(),
  user_address: paymentProof.payer,
});

// Loggear errores de pago
logger.warn('x402_payment_failed', {
  capability: name,
  error: err.code,
  timestamp: new Date().toISOString(),
});
```

### Métricas a Trackear

| Métrica | Descripción |
|---------|-------------|
| `payments_total` | Total de pagos recibidos |
| `payments_by_capability` | Pagos por capability |
| `payment_failures` | Pagos fallidos |
| `revenue_total` | Revenue total en USDC |
| `avg_response_time` | Tiempo promedio de respuesta |

---

## Pricing Strategy

### Actual (MVP)

| Capability | Precio | Justificación |
|------------|--------|---------------|
| contract.scan | $0.01 | Bajo costo, alta frecuencia |
| wallet.approvals | $0.02 | Más cómputo requerido |
| tx.simulate | $0.03 | Llamadas a contratos |

### Costo Real por Capability

| Capability | Costo Claude | Costo RPC | Costo Total | Margen |
|------------|--------------|-----------|-------------|--------|
| contract.scan | ~$0.002 | ~$0.001 | ~$0.003 | 70% |
| wallet.approvals | ~$0.003 | ~$0.002 | ~$0.005 | 75% |
| tx.simulate | ~$0.003 | ~$0.003 | ~$0.006 | 80% |

### Futuro (Post-MVP)

Posibilidades:
- Bundles: "Security Pack" ($0.05 por 3 capabilities)
- Suscripción: $X/mes por uso ilimitado
- Descuentos por volumen
